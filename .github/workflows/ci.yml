name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Check Terraform formatting
        run: terraform fmt -check -recursive -diff
        working-directory: infrastructure/proxmox

  terraform-consistency:
    name: Terraform Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Verify lock files exist
        run: |
          missing=0
          for dir in \
            infrastructure/proxmox/modules/vm \
            infrastructure/proxmox/modules/lxc \
            infrastructure/proxmox/modules/backup \
            infrastructure/proxmox/modules/minio \
            infrastructure/proxmox/modules/monitoring-stack \
            infrastructure/proxmox/modules/tooling-stack \
            infrastructure/proxmox/environments/prod \
            infrastructure/proxmox/environments/lab \
            infrastructure/proxmox/environments/monitoring; do
            if [ ! -f "$dir/.terraform.lock.hcl" ]; then
              echo "::error::Missing lock file: $dir/.terraform.lock.hcl"
              missing=$((missing + 1))
            fi
          done
          if [ "$missing" -gt 0 ]; then
            echo "::error::$missing lock file(s) missing. Run 'terraform init' in each directory."
            exit 1
          fi
          echo "All 9 lock files present."

      - name: Verify provider version consistency
        run: |
          # Extract all proxmox provider versions from versions.tf
          versions=$(grep -rh 'version.*=.*"~>' infrastructure/proxmox/*/versions.tf infrastructure/proxmox/*/*/versions.tf 2>/dev/null | grep -o '"~>[^"]*"' | sort -u)
          count=$(echo "$versions" | wc -l)
          if [ "$count" -gt 1 ]; then
            echo "::error::Inconsistent provider versions found:"
            grep -rn 'version.*=.*"~>' infrastructure/proxmox/*/versions.tf infrastructure/proxmox/*/*/versions.tf 2>/dev/null
            exit 1
          fi
          echo "Provider version consistent across all modules: $versions"

      - name: Verify shared symlinks
        run: |
          broken=0
          for link in $(find infrastructure/proxmox/environments -type l 2>/dev/null); do
            if [ ! -e "$link" ]; then
              echo "::error::Broken symlink: $link -> $(readlink "$link")"
              broken=$((broken + 1))
            fi
          done
          if [ "$broken" -gt 0 ]; then
            echo "::error::$broken broken symlink(s) found."
            exit 1
          fi
          echo "All symlinks valid."

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    strategy:
      matrix:
        directory:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
          - infrastructure/proxmox/environments/prod
          - infrastructure/proxmox/environments/lab
          - infrastructure/proxmox/environments/monitoring
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Create Terraform plugin cache dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Cache Terraform plugins
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-plugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-plugins-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ matrix.directory }}

  terraform-test:
    name: Terraform Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [terraform-validate]
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    strategy:
      matrix:
        module:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
          - infrastructure/proxmox/environments/prod
          - infrastructure/proxmox/environments/lab
          - infrastructure/proxmox/environments/monitoring
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Create Terraform plugin cache dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Cache Terraform plugins
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-plugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-plugins-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.module }}

      - name: Terraform Test
        run: terraform test
        working-directory: ${{ matrix.module }}

  terraform-docs:
    name: Terraform Docs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        module:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check terraform-docs is up to date
        uses: terraform-docs/gh-actions@6de6da0cefcc6b4b7a5cbea4d79d97060733093c # v1
        with:
          working-dir: ${{ matrix.module }}
          output-file: README.md
          output-method: inject
          fail-on-diff: true

  shell-test:
    name: Shell Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install dependencies
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt-get update && sudo apt-get install -y shellcheck bats gum
      - name: Shellcheck scripts
        run: find scripts -name "*.sh" -type f -print0 | xargs -0 shellcheck -x -S warning
      - name: Shellcheck module scripts
        run: |
          # Check plain .sh files in module files/ directories
          find infrastructure/proxmox/modules -path '*/files/*.sh' -type f -print0 | xargs -0 --no-run-if-empty shellcheck -x -S warning
          # Check .sh.tpl files (strip Terraform template directives first)
          for f in $(find infrastructure/proxmox/modules -path '*/files/*.sh.tpl' -type f); do
            tmp=$(mktemp)
            sed -e 's/%{[^}]*}//g' -e 's/\${[^}]*}/PLACEHOLDER/g' "$f" > "$tmp"
            shellcheck -x -S warning "$tmp" || { echo "shellcheck failed on $f"; rm "$tmp"; exit 1; }
            rm "$tmp"
          done
      - name: BATS tests
        run: |
          # Run all test directories except:
          # - tests/drift/ (requires terraform environments)
          bats tests/ tests/health/ tests/lifecycle/ tests/restore/ tests/scripts/ tests/tui/

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: |
            **/*.md
            !.claude/**/*.md
            !node_modules/**/*.md
        continue-on-error: true
