name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Check Terraform formatting
        run: terraform fmt -check -recursive -diff
        working-directory: infrastructure/proxmox

  terraform-consistency:
    name: Terraform Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Verify lock files exist
        run: |
          missing=0
          for dir in \
            infrastructure/proxmox/modules/vm \
            infrastructure/proxmox/modules/lxc \
            infrastructure/proxmox/modules/backup \
            infrastructure/proxmox/modules/minio \
            infrastructure/proxmox/modules/monitoring-stack \
            infrastructure/proxmox/modules/tooling-stack \
            infrastructure/proxmox/environments/prod \
            infrastructure/proxmox/environments/lab \
            infrastructure/proxmox/environments/monitoring; do
            if [ ! -f "$dir/.terraform.lock.hcl" ]; then
              echo "::error::Missing lock file: $dir/.terraform.lock.hcl"
              missing=$((missing + 1))
            fi
          done
          if [ "$missing" -gt 0 ]; then
            echo "::error::$missing lock file(s) missing. Run 'terraform init' in each directory."
            exit 1
          fi
          echo "All 9 lock files present."

      - name: Verify provider version consistency
        run: |
          # Extract proxmox provider versions only (filter by bpg/proxmox context)
          versions=$(grep -B1 -A1 'bpg/proxmox' infrastructure/proxmox/*/versions.tf infrastructure/proxmox/*/*/versions.tf 2>/dev/null | grep 'version' | grep -o '"~>[^"]*"' | sort -u)
          count=$(echo "$versions" | wc -l)
          if [ "$count" -gt 1 ]; then
            echo "::error::Inconsistent proxmox provider versions found:"
            grep -B1 -A1 'bpg/proxmox' infrastructure/proxmox/*/versions.tf infrastructure/proxmox/*/*/versions.tf 2>/dev/null | grep 'version'
            exit 1
          fi
          echo "Proxmox provider version consistent across all modules: $versions"

      - name: Verify shared symlinks
        run: |
          broken=0
          for link in $(find infrastructure/proxmox/environments -type l 2>/dev/null); do
            if [ ! -e "$link" ]; then
              echo "::error::Broken symlink: $link -> $(readlink "$link")"
              broken=$((broken + 1))
            fi
          done
          if [ "$broken" -gt 0 ]; then
            echo "::error::$broken broken symlink(s) found."
            exit 1
          fi
          echo "All symlinks valid."

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        directory:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6.2.1
        with:
          tflint_version: latest

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Run TFLint
        run: tflint --format=compact
        working-directory: ${{ matrix.directory }}

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    strategy:
      matrix:
        directory:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
          - infrastructure/proxmox/environments/prod
          - infrastructure/proxmox/environments/lab
          - infrastructure/proxmox/environments/monitoring
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Create Terraform plugin cache dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Cache Terraform plugins
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-plugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-plugins-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.directory }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ matrix.directory }}

  terraform-test:
    name: Terraform Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [terraform-validate]
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    strategy:
      matrix:
        module:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
          - infrastructure/proxmox/environments/prod
          - infrastructure/proxmox/environments/lab
          - infrastructure/proxmox/environments/monitoring
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Create Terraform plugin cache dir
        run: mkdir -p $TF_PLUGIN_CACHE_DIR

      - name: Cache Terraform plugins
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-plugins-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-plugins-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: '1.9.8'

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ${{ matrix.module }}

      - name: Terraform Test
        run: terraform test
        working-directory: ${{ matrix.module }}

  terraform-docs:
    name: Terraform Docs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        module:
          - infrastructure/proxmox/modules/vm
          - infrastructure/proxmox/modules/lxc
          - infrastructure/proxmox/modules/backup
          - infrastructure/proxmox/modules/minio
          - infrastructure/proxmox/modules/monitoring-stack
          - infrastructure/proxmox/modules/tooling-stack
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Check terraform-docs is up to date
        uses: terraform-docs/gh-actions@6de6da0cefcc6b4b7a5cbea4d79d97060733093c # v1
        with:
          working-dir: ${{ matrix.module }}
          output-file: README.md
          output-method: inject
          fail-on-diff: true

  shell-test:
    name: Shell Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y shellcheck bats
      - name: Shellcheck scripts
        run: find scripts -name "*.sh" -type f -print0 | xargs -0 shellcheck -x -S warning
      - name: Shellcheck module scripts
        run: |
          # Check plain .sh files in module files/ directories
          find infrastructure/proxmox/modules -path '*/files/*.sh' -type f -print0 | xargs -0 --no-run-if-empty shellcheck -x -S warning
          # Check .sh.tpl files (strip Terraform template directives first)
          for f in $(find infrastructure/proxmox/modules -path '*/files/*.sh.tpl' -type f); do
            tmp=$(mktemp)
            sed -e 's/%{[^}]*}//g' -e 's/\${[^}]*}/PLACEHOLDER/g' "$f" > "$tmp"
            shellcheck -x -S warning "$tmp" || { echo "shellcheck failed on $f"; rm "$tmp"; exit 1; }
            rm "$tmp"
          done
      - name: BATS tests
        run: |
          # Run all test directories except:
          # - tests/tui/ (requires gum)
          # - tests/drift/ (requires terraform environments)
          bats tests/ tests/health/ tests/lifecycle/ tests/restore/ tests/scripts/

  terraform-security:
    name: Terraform Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Run Trivy IaC scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: 'config'
          scan-ref: 'infrastructure/proxmox'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          trivyignores: '.trivyignore'

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: |
            **/*.md
            !.claude/**/*.md
            !node_modules/**/*.md
        continue-on-error: true

  pr-summary:
    name: PR Summary
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [terraform-fmt, terraform-consistency, terraform-lint, terraform-validate, terraform-test, terraform-docs, shell-test, terraform-security]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Post PR summary
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        with:
          script: |
            const { execSync } = require('child_process');
            const base = context.payload.pull_request.base.sha;
            const head = context.payload.pull_request.head.sha;
            const diff = execSync(`git diff --name-only ${base} ${head}`).toString();
            const files = diff.split('\n').filter(Boolean);

            const modules = ['vm', 'lxc', 'backup', 'minio', 'monitoring-stack', 'tooling-stack'];
            const envs = ['prod', 'lab', 'monitoring'];

            const changedModules = modules.filter(m =>
              files.some(f => f.includes(`modules/${m}/`))
            );
            const changedEnvs = envs.filter(e =>
              files.some(f => f.includes(`environments/${e}/`))
            );
            const changedScripts = files.some(f => f.startsWith('scripts/'));
            const changedCI = files.some(f => f.startsWith('.github/'));
            const changedShared = files.some(f => f.includes('shared/'));

            let body = '## Terraform CI Summary\n\n';
            body += `**${files.length}** files changed\n\n`;

            if (changedModules.length > 0) {
              body += '**Modules:** ' + changedModules.map(m => `\`${m}\``).join(', ') + '\n';
            }
            if (changedEnvs.length > 0) {
              body += '**Environments:** ' + changedEnvs.map(e => `\`${e}\``).join(', ') + '\n';
            }
            if (changedShared) body += '**Shared:** configuration modified\n';
            if (changedScripts) body += '**Scripts:** shell scripts modified\n';
            if (changedCI) body += '**CI/CD:** workflow modified\n';

            body += '\nAll CI checks passed.';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body?.includes('Terraform CI Summary'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
