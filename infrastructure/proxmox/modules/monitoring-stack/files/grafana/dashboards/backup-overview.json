{
  "id": null,
  "uid": "backup-overview",
  "title": "Backup Overview",
  "description": "Backup coverage, storage usage, and guest protection status. Requires pve-exporter >= 3.7.0.",
  "tags": [
    "backup",
    "vzdump",
    "proxmox"
  ],
  "timezone": "browser",
  "editable": false,
  "graphTooltip": 1,
  "refresh": "5m",
  "time": {
    "from": "now-7d",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "name": "node",
        "type": "query",
        "datasource": {
          "type": "prometheus",
          "uid": "prometheus"
        },
        "query": "label_values(pve_up{id=~\"node/.*\"}, node)",
        "definition": "label_values(pve_up{id=~\"node/.*\"}, node)",
        "refresh": 2,
        "includeAll": true,
        "multi": true,
        "current": {
          "selected": true,
          "text": "All",
          "value": "$__all"
        }
      }
    ]
  },
  "panels": [
    {
      "title": "Backup Coverage",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "collapsed": false
    },
    {
      "title": "Guests Not Backed Up",
      "type": "stat",
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 1 },
              { "color": "red", "value": 3 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "none",
        "textMode": "value_and_name"
      },
      "targets": [
        {
          "expr": "pve_backup_not_enabled_total or vector(0)",
          "legendFormat": "Unprotected Guests",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Total Guests",
      "type": "stat",
      "gridPos": { "h": 6, "w": 6, "x": 6, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "blue", "value": null }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "none",
        "textMode": "value_and_name"
      },
      "targets": [
        {
          "expr": "count(pve_guest_info{node=~\"$node\", template!=\"1\"}) or vector(0)",
          "legendFormat": "VMs + LXC",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Active Backup Alerts",
      "type": "stat",
      "gridPos": { "h": 6, "w": 6, "x": 12, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "none",
        "textMode": "value_and_name"
      },
      "targets": [
        {
          "expr": "count(ALERTS{alertname=~\"Backup.*|GuestsNotBackedUp\", alertstate=\"firing\"}) or vector(0)",
          "legendFormat": "Firing Alerts",
          "refId": "A"
        }
      ]
    },
    {
      "title": "All Storage Usage",
      "type": "gauge",
      "gridPos": { "h": 6, "w": 6, "x": 18, "y": 1 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "min": 0,
          "max": 1,
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.7 },
              { "color": "red", "value": 0.85 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "targets": [
        {
          "expr": "avg(pve_disk_usage_bytes{id=~\"storage/.*\", node=~\"$node\"} / pve_disk_size_bytes{id=~\"storage/.*\", node=~\"$node\"})",
          "legendFormat": "Average",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Unprotected Guests (no backup job)",
      "type": "table",
      "gridPos": { "h": 3, "w": 24, "x": 0, "y": 7 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "noValue": "All guests are covered by a backup job",
          "custom": {
            "align": "auto",
            "cellOptions": { "type": "auto" }
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Guest" },
            "properties": [
              { "id": "custom.width", "value": 200 },
              { "id": "custom.cellOptions", "value": { "type": "color-text" } },
              { "id": "color", "value": { "mode": "fixed", "fixedColor": "orange" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [
              { "id": "custom.hidden", "value": true }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Time" },
            "properties": [
              { "id": "custom.hidden", "value": true }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "footer": { "show": false }
      },
      "transformations": [
        {
          "id": "organize",
          "options": {
            "renameByName": {
              "name": "Guest",
              "id": "ID"
            }
          }
        }
      ],
      "targets": [
        {
          "expr": "pve_backup_not_enabled_info",
          "format": "table",
          "instant": true,
          "refId": "A"
        }
      ]
    },
    {
      "title": "Storage",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 10 },
      "collapsed": false
    },
    {
      "title": "Storage Usage by Pool",
      "type": "bargauge",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 11 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "min": 0,
          "max": 1,
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.7 },
              { "color": "red", "value": 0.85 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "displayMode": "gradient",
        "orientation": "horizontal",
        "showUnfilled": true
      },
      "targets": [
        {
          "expr": "pve_disk_usage_bytes{id=~\"storage/.*\", node=~\"$node\"} / pve_disk_size_bytes{id=~\"storage/.*\", node=~\"$node\"}",
          "legendFormat": "{{ node }} / {{ id }}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Storage Space Allocation",
      "type": "bargauge",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 11 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "thresholds": {
            "steps": [
              { "color": "blue", "value": null }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "displayMode": "gradient",
        "orientation": "horizontal",
        "showUnfilled": true
      },
      "targets": [
        {
          "expr": "pve_disk_size_bytes{id=~\"storage/.*\", node=~\"$node\"}",
          "legendFormat": "{{ node }} / {{ id }}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Storage Usage Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 19 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "min": 0,
          "max": 1,
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 15,
            "pointSize": 5,
            "showPoints": "auto"
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.7 },
              { "color": "red", "value": 0.85 }
            ]
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "calcs": ["lastNotNull", "min", "max"]
        },
        "tooltip": { "mode": "multi" }
      },
      "targets": [
        {
          "expr": "pve_disk_usage_bytes{id=~\"storage/.*\", node=~\"$node\"} / pve_disk_size_bytes{id=~\"storage/.*\", node=~\"$node\"}",
          "legendFormat": "{{ node }} / {{ id }}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Guest Inventory",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 27 },
      "collapsed": false
    },
    {
      "title": "Guest Resource Allocation",
      "type": "table",
      "gridPos": { "h": 12, "w": 24, "x": 0, "y": 28 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "cellOptions": { "type": "auto" },
            "inspect": false
          },
          "links": [
            {
              "title": "View in PVE Exporter dashboard",
              "url": "/d/pve-exporter?var-node=${__data.fields.Node}&from=${__from}&to=${__to}",
              "targetBlank": false
            }
          ]
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Node" },
            "properties": [
              { "id": "custom.width", "value": 120 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Guest" },
            "properties": [
              { "id": "custom.width", "value": 160 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Type" },
            "properties": [
              { "id": "custom.width", "value": 70 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Status" },
            "properties": [
              { "id": "custom.width", "value": 80 },
              { "id": "custom.cellOptions", "value": { "type": "color-text" } },
              {
                "id": "mappings",
                "value": [
                  {
                    "type": "value",
                    "options": {
                      "1": { "color": "green", "text": "UP" },
                      "0": { "color": "red", "text": "DOWN" }
                    }
                  }
                ]
              }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "CPU %" },
            "properties": [
              { "id": "unit", "value": "percentunit" },
              { "id": "custom.width", "value": 100 },
              { "id": "decimals", "value": 1 },
              {
                "id": "custom.cellOptions",
                "value": { "type": "gauge", "mode": "gradient" }
              },
              {
                "id": "thresholds",
                "value": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "orange", "value": 0.7 },
                    { "color": "red", "value": 0.9 }
                  ]
                }
              },
              { "id": "min", "value": 0 },
              { "id": "max", "value": 1 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Mem %" },
            "properties": [
              { "id": "unit", "value": "percentunit" },
              { "id": "custom.width", "value": 100 },
              { "id": "decimals", "value": 1 },
              {
                "id": "custom.cellOptions",
                "value": { "type": "gauge", "mode": "gradient" }
              },
              {
                "id": "thresholds",
                "value": {
                  "steps": [
                    { "color": "green", "value": null },
                    { "color": "orange", "value": 0.7 },
                    { "color": "red", "value": 0.9 }
                  ]
                }
              },
              { "id": "min", "value": 0 },
              { "id": "max", "value": 1 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Disk" },
            "properties": [
              { "id": "unit", "value": "bytes" },
              { "id": "custom.width", "value": 100 },
              { "id": "decimals", "value": 1 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Uptime" },
            "properties": [
              { "id": "unit", "value": "s" },
              { "id": "custom.width", "value": 100 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "HA" },
            "properties": [
              { "id": "custom.width", "value": 70 },
              { "id": "custom.cellOptions", "value": { "type": "color-text" } },
              {
                "id": "mappings",
                "value": [
                  {
                    "type": "value",
                    "options": {
                      "0": { "color": "text", "text": "-" },
                      "1": { "color": "green", "text": "HA" }
                    }
                  }
                ]
              }
            ]
          }
        ]
      },
      "options": {
        "showHeader": true,
        "sortBy": [
          { "displayName": "Node", "desc": false }
        ],
        "footer": { "show": false }
      },
      "transformations": [
        {
          "id": "seriesToColumns",
          "options": { "byField": "vm_key" }
        },
        {
          "id": "filterFieldsByName",
          "options": {
            "include": {
              "pattern": "(^name|^node|^type|Value #[B-G])"
            }
          }
        },
        {
          "id": "organize",
          "options": {
            "renameByName": {
              "node": "Node",
              "node 1": "Node",
              "name": "Guest",
              "name 1": "Guest",
              "type": "Type",
              "type 1": "Type",
              "Value #B": "Status",
              "Value #C": "CPU %",
              "Value #D": "Mem %",
              "Value #E": "Disk",
              "Value #F": "Uptime",
              "Value #G": "HA"
            },
            "indexByName": {
              "node": 0,
              "node 1": 0,
              "name": 1,
              "name 1": 1,
              "type": 2,
              "type 1": 2,
              "Value #B": 3,
              "Value #C": 4,
              "Value #D": 5,
              "Value #E": 6,
              "Value #F": 7,
              "Value #G": 8
            }
          }
        }
      ],
      "targets": [
        {
          "expr": "label_join(sum by (id, instance, name, type, node) (pve_guest_info{node=~\"$node\", template!=\"1\"}), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "A"
        },
        {
          "expr": "label_join(sum by (id, instance) (pve_up{node=~\"$node\"} and on (id, instance) pve_guest_info{template!=\"1\"}), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "B"
        },
        {
          "expr": "label_join(sum by (id, instance) (pve_cpu_usage_ratio{node=~\"$node\"} and on (id, instance) pve_guest_info{template!=\"1\"}), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "C"
        },
        {
          "expr": "label_join(sum by (id, instance) (pve_memory_usage_bytes{node=~\"$node\", template!=\"1\"} / pve_memory_size_bytes and on (id, instance) pve_guest_info{template!=\"1\"} and on (id, instance) pve_up == 1), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "D"
        },
        {
          "expr": "label_join(sum by (id, instance) (pve_disk_size_bytes{node=~\"$node\"} and on (id, instance) pve_guest_info{template!=\"1\"}), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "E"
        },
        {
          "expr": "label_join(sum by (id, instance) (pve_uptime_seconds_total{node=~\"$node\"} and on (id, instance) pve_guest_info{template!=\"1\"} and on (id, instance) pve_up == 1), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "F"
        },
        {
          "expr": "label_join(sum by (id, instance) (pve_ha_state{node=~\"$node\"} and on (id, instance) pve_guest_info{template!=\"1\"}), \"vm_key\", \"@\", \"id\", \"instance\")",
          "format": "table",
          "instant": true,
          "refId": "G"
        }
      ]
    }
  ],
  "schemaVersion": 39,
  "version": 2
}
